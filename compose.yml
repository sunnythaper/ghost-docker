configs:
  create-multiple-databases:
    content: |
      #!/bin/bash

      set -e
      set -u

      if [ -n "$$MYSQL_MULTIPLE_DATABASES" ]; then
        echo "Creating multiple databases: $$MYSQL_MULTIPLE_DATABASES"

        for db in $$(echo "$$MYSQL_MULTIPLE_DATABASES" | tr ',' ' '); do
          echo "Creating database: $$db"
          mysql -u root -p"$$MYSQL_ROOT_PASSWORD" <<-EOSQL
            CREATE DATABASE IF NOT EXISTS \`$$db\`;
            GRANT ALL ON \`$$db\`.* TO '$$MYSQL_USER'@'%';
      EOSQL
        done

        echo "Multiple databases created"
      fi

volumes:
  ghost-content:
  mysql-data:
  redis-data:

services:
  ghost:
    image: ghost:${GHOST_VERSION:-6-alpine}
    restart: always
    volumes:
      - ghost-content:/var/lib/ghost/content
    environment:
      NODE_ENV: production
      url: $SERVICE_URL_GHOST
      database__client: mysql
      database__connection__host: db
      database__connection__user: $SERVICE_USER_MYSQL
      database__connection__password: $SERVICE_PASSWORD_MYSQL
      database__connection__database: ghost
    depends_on:
      db:
        condition: service_healthy
      activitypub:
        condition: service_started
        required: false
    healthcheck:
      test:
        - CMD
        - echo
        - ok
      interval: 5s
      timeout: 20s
      retries: 10

  db:
    image: mysql:8.0.42@sha256:4445b2668d41143cb50e471ee207f8822006249b6859b24f7e12479684def5d9
    restart: always
    volumes:
      - mysql-data:/var/lib/mysql
    configs:
      - source: create-multiple-databases
        target: /docker-entrypoint-initdb.d/create-multiple-databases.sh
    environment:
      MYSQL_ROOT_PASSWORD: $SERVICE_PASSWORD_MYSQLROOT
      MYSQL_USER: $SERVICE_USER_MYSQL
      MYSQL_PASSWORD: $SERVICE_PASSWORD_MYSQL
      MYSQL_DATABASE: ghost
      MYSQL_MULTIPLE_DATABASES: activitypub
    healthcheck:
      test:
        - CMD
        - mysqladmin
        - ping
        - '-h'
        - 127.0.0.1
      interval: 5s
      timeout: 20s
      retries: 10

  activitypub:
    image: ghcr.io/tryghost/activitypub:1.1.0@sha256:39c212fe23603b182d68e67d555c6b9b04b1e57459dfc0bef26d6e4980eb04d1
    restart: always
    volumes:
      - ghost-content:/opt/activitypub/content
    environment:
      NODE_ENV: production
      PORT: ${ACTIVITYPUB_PORT:-8080}
      MYSQL_HOST: db
      MYSQL_USER: $SERVICE_USER_MYSQL
      MYSQL_PASSWORD: $SERVICE_PASSWORD_MYSQL
      MYSQL_DATABASE: activitypub
      LOCAL_STORAGE_PATH: /opt/activitypub/content/images/activitypub
      LOCAL_STORAGE_HOSTING_URL: $SERVICE_URL_GHOST/content/images/activitypub
      REDIS_HOST: redis
      REDIS_PORT: 6379
      FEDIFY_KV_STORE_TYPE: redis
    depends_on:
      db:
        condition: service_healthy
      activitypub-migrate:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - echo
        - ok
      interval: 5s
      timeout: 20s
      retries: 10

  redis:
    image: redis:alpine
    restart: always
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
    healthcheck:
      test:
        - CMD
        - 'redis-cli'
        - ping
      interval: 10s
      timeout: 5s
      retries: 3

  activitypub-migrate:
    image: ghcr.io/tryghost/activitypub-migrations:1.1.0@sha256:b3ab20f55d66eb79090130ff91b57fe93f8a4254b446c2c7fa4507535f503662
    restart: no
    environment:
      MYSQL_DB: mysql://$SERVICE_USER_MYSQL:$SERVICE_PASSWORD_MYSQL@tcp(db:3306)/activitypub
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test:
        - CMD
        - echo
        - ok
      interval: 5s
      timeout: 20s
      retries: 10